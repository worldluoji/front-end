ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°
ä½ çœŸçš„äº†è§£å‰ç«¯æ¨¡å—åŒ–ä¹ˆï¼Ÿ

å‘Šåˆ«ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€
webpackæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå¤æ‚çš„å‰ç«¯è‡ªåŠ¨åŒ–å·¥å…·ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯é…ç½®å¤æ‚ï¼Œè¿™ä¹Ÿä½¿å¾—ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€è¿™ç§æˆè°‘çš„ç§°å‘¼å¼€å§‹æµè¡ŒğŸ¤·ä½†æ˜¯ï¼Œéš¾é“ä½ çœŸçš„åªæ»¡è¶³äºç©è½¬webpacké…ç½®ä¹ˆï¼Ÿ

æ˜¾ç„¶ä¸æ˜¯ã€‚åœ¨å­¦ä¹ å¦‚ä½•ä½¿ç”¨webpackä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ·±å…¥webpackå†…éƒ¨ï¼Œæ¢ç´¢å„éƒ¨åˆ†çš„è®¾è®¡ä¸å®ç°ã€‚ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œå³ä½¿æœ‰ä¸€å¤©webpackâ€œè¿‡æ°”â€äº†ï¼Œä½†å®ƒçš„æŸäº›è®¾è®¡ä¸å®ç°å´ä»ä¼šæœ‰å­¦ä¹ ä»·å€¼ä¸å€Ÿé‰´æ„ä¹‰ã€‚

1. å¼•è¨€
ä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚ä¸€ç›´ä»¥æ¥ï¼Œåœ¨å‰ç«¯é¢†åŸŸï¼Œå¼€å‘äººå‘˜æ—¥ç›Šå¢é•¿çš„è¯­è¨€èƒ½åŠ›éœ€æ±‚å’Œè½åçš„JavaScriptè§„èŒƒå½¢æˆäº†ä¸€å¤§çŸ›ç›¾ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼šç”¨babelæ¥è¿›è¡ŒES6åˆ°ES5çš„è¯­æ³•è½¬æ¢ï¼Œä¼šä½¿ç”¨å„ç§polyfillæ¥å…¼å®¹è€å¼ä¸Šçš„æ–°ç‰¹æ€§â€¦â€¦è€Œæˆ‘ä»¬æœ¬æ–‡çš„ä¸»è§’ â€”â€” æ¨¡å—åŒ–ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

ç”±äºJavaScriptåœ¨è®¾è®¡ä¹‹åˆå°±æ²¡æœ‰è€ƒè™‘è¿™ä¸€ç‚¹ï¼ŒåŠ ä¹‹æ¨¡å—åŒ–è§„èŒƒçš„è¿Ÿåˆ°ï¼Œå¯¼è‡´ç¤¾åŒºä¸­æ¶Œç°å‡ºä¸€ç³»åˆ—å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œä¾‹å¦‚RequireJSã€seaJSç­‰ã€‚ä»¥åŠä¸ä¹‹å¯¹åº”çš„ç¼–è¯‘æœŸæ¨¡å—ä¾èµ–è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚browserifyã€rollupå’Œæœ¬æ–‡çš„ä¸»è§’webpackã€‚

ä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“ï¼Œ<script type="module">è¿˜å­˜åœ¨ä¸€å®šçš„å…¼å®¹æ€§ä¸ä½¿ç”¨é—®é¢˜ã€‚


image
åœ¨æ›´é€šç”¨çš„èŒƒå›´å†…æ¥è®²ï¼Œæµè§ˆå™¨åŸç”Ÿå®é™…æ˜¯ä¸æ”¯æŒæ‰€è°“çš„CommonJSæˆ–ESMæ¨¡å—åŒ–è§„èŒƒçš„ã€‚é‚£ä¹ˆwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°æ¨¡å—åŒ–çš„å‘¢ï¼Ÿ

2. NodeJSä¸­çš„æ¨¡å—åŒ–
åœ¨æ¢ç©¶webpackæ‰“åŒ…åä»£ç çš„æ¨¡å—åŒ–å®ç°å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Nodeä¸­çš„æ¨¡å—åŒ–ã€‚

NodeJSï¼ˆä»¥ä¸‹ç®€ç§°ä¸ºNodeï¼‰åœ¨æ¨¡å—åŒ–ä¸ŠåŸºæœ¬æ˜¯éµå¾ªçš„CommonJSè§„èŒƒï¼Œè€Œwebpackæ‰“åŒ…å‡ºæ¥çš„ä»£ç æ‰€å®ç°æ¨¡å—åŒ–çš„æ–¹å¼ï¼Œä¹Ÿç±»ä¼¼äºCommonJSã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…ˆä»¥ç†Ÿæ‚‰çš„Nodeï¼ˆè¿™é‡Œä¸»è¦å‚è€ƒNode v10ï¼‰ä½œä¸ºå¼•å­ï¼Œç®€å•ä»‹ç»å®ƒçš„æ¨¡å—åŒ–å®ç°ï¼Œå¸®åŠ©æˆ‘ä»¬æ¥ä¸‹æ¥ç†è§£webpackçš„å®ç°ã€‚

Nodeä¸­çš„æ¨¡å—å¼•å…¥ä¼šç»å†ä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š

è·¯å¾„åˆ†æ
æ–‡ä»¶å®šä½
ç¼–è¯‘æ‰§è¡Œ
åœ¨Nodeä¸­ï¼Œæ¨¡å—ä»¥æ–‡ä»¶ç»´åº¦å­˜åœ¨ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘åç¼“å­˜äºå†…å­˜ä¸­ï¼Œé€šè¿‡require.cacheå¯ä»¥æŸ¥çœ‹æ¨¡å—ç¼“å­˜æƒ…å†µã€‚åœ¨æ¨¡å—ä¸­æ·»åŠ console.log(require.cache)æŸ¥çœ‹è¾“å‡ºå¦‚ä¸‹ï¼š

{ '/Users/alienzhou/programming/gitrepo/test.js':
   Module {
     id: '.',
     exports: {},
     parent: null,
     filename: '/Users/alienzhou/programming/gitrepo/test.js',
     loaded: false,
     children: [],
     paths:
      [ '/Users/alienzhou/programming/gitrepo/node_modules',
        '/Users/alienzhou/programming/node_modules',
        '/Users/alienzhou/node_modules',
        '/Users/node_modules',
        '/node_modules' ] } }
ä¸Šé¢å°±æ˜¯æ¨¡å—å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥åœ¨Nodeæºç ä¸­æ‰¾åˆ°Moduleç±»çš„æ„é€ æ–¹æ³•ã€‚å…¶ä¸­exportså±æ€§éå¸¸é‡è¦ï¼Œå®ƒå°±æ˜¯æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ã€‚å› æ­¤ï¼Œä¸‹é¢è¿™è¡Œè¯­å¥

var test = require('./test.js');
å…¶å®å°±æ˜¯æŠŠtest.jsæ¨¡å—çš„exportså±æ€§èµ‹å€¼ç»™testå˜é‡ã€‚

ä¹Ÿè®¸ä½ è¿˜ä¼šå¥½å¥‡ï¼Œå½“æˆ‘ä»¬å†™ä¸€ä¸ªNode(JavaScript)æ¨¡å—æ—¶ï¼Œæ¨¡å—é‡Œçš„moduleã€requireã€__filenameç­‰è¿™äº›å˜é‡æ˜¯å“ªæ¥çš„ï¼Ÿå¦‚æœä½ çœ‹è¿‡Node loader.js éƒ¨åˆ†æºç ï¼Œåº”è¯¥å°±å¤§è‡´èƒ½ç†è§£ï¼š

Module.wrap = function(script) {
  return Module.wrapper[0] + script + Module.wrapper[1];
};

Module.wrapper = [
  '(function (exports, require, module, __filename, __dirname) { ',
  '\n});'
];
Nodeä¼šè‡ªåŠ¨å°†æ¯ä¸ªæ¨¡å—è¿›è¡ŒåŒ…è£…ï¼ˆwrapï¼‰ï¼Œå°†å…¶å˜ä¸ºä¸€ä¸ªfunctionã€‚ä¾‹å¦‚æ¨¡å—test.jsåŸæœ¬ä¸ºï¼š

console.log(require.cache);
module.exports = 'test';
åŒ…è£…åå¤§è‡´ä¼šå˜ä¸ºï¼š

(function (exports, require, module, __filename, __dirname) {
    console.log(require.cache);
    module.exports = 'test';
});
è¿™ä¸‹ä½ åº”è¯¥æ˜ç™½moduleã€requireã€__filenameè¿™äº›å˜é‡éƒ½æ˜¯å“ªæ¥çš„äº†å§ â€”â€” å®ƒä»¬ä¼šè¢«ä½œä¸ºfunctionçš„å‚æ•°åœ¨æ¨¡å—ç¼–è¯‘æ‰§è¡Œæ—¶æ³¨å…¥è¿›æ¥ã€‚ä»¥ä¸€ä¸ªæ‰©å±•åä¸º.jsçš„æ¨¡å—ä¸ºä¾‹ï¼Œå½“ä½ requireå®ƒæ—¶ï¼Œä¸€ä¸ªå®Œæ•´çš„æ–¹æ³•è°ƒç”¨å¤§è‡´åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¿‡ç¨‹ï¼š

st=>start: require()å¼•å…¥æ¨¡å—
op1=>operation: è°ƒç”¨._load()åŠ è½½æ¨¡å—
op2=>operation: new Module(filename, parent)åˆ›å»ºæ¨¡å—å¯¹è±¡
op3=>operation: å°†æ¨¡å—å¯¹è±¡å­˜å…¥ç¼“å­˜
op4=>operation: æ ¹æ®æ–‡ä»¶ç±»å‹è°ƒç”¨Module._extensions
op5=>operation: è°ƒç”¨.compile()ç¼–è¯‘æ‰§è¡Œjsæ¨¡å—
cond=>condition: Module._cacheæ˜¯å¦æ— ç¼“å­˜
e=>end: è¿”å›module.exportsç»“æœ
st->op1->cond
cond(yes)->op2->op3->op4->op5->e
cond(no)->e
åœ¨Nodeæºç ä¸­èƒ½çœ‹åˆ°ï¼Œæ¨¡å—æ‰§è¡Œæ—¶ï¼ŒåŒ…è£…å®šä¹‰çš„å‡ ä¸ªå˜é‡è¢«æ³¨å…¥äº†ï¼š

if (inspectorWrapper) {
    result = inspectorWrapper(compiledWrapper, this.exports, this.exports,
                              require, this, filename, dirname);

} else {
    result = compiledWrapper.call(this.exports, this.exports, require, this,
                                  filename, dirname);
}

é¢˜å¤–è¯ï¼Œä»è¿™é‡Œä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨æ¨¡å—å†…ä½¿ç”¨module.exportsä¸exportsçš„åŒºåˆ«

3. webpackå®ç°çš„å‰ç«¯æ¨¡å—åŒ–
ä¹‹æ‰€ä»¥åœ¨ä»‹ç»ã€Œwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°æ¨¡å—åŒ–ã€ä¹‹å‰ï¼Œå…ˆç”¨ä¸€å®šç¯‡å¹…ä»‹ç»äº†Nodeä¸­çš„æ¨¡å—åŒ–ï¼Œæ˜¯å› ä¸ºä¸¤è€…åœ¨åŒæ­¥ä¾èµ–çš„è®¾è®¡ä¸å®ç°ä¸Šæœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚ç†è§£Nodeçš„æ¨¡å—åŒ–å¯¹å­¦ä¹ webpackå¾ˆæœ‰å¸®åŠ©ã€‚å½“ç„¶ï¼Œç”±äºè¿è¡Œç¯å¢ƒçš„ä¸åŒï¼ˆwebpackæ‰“åŒ…å‡ºçš„ä»£ç è¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œè€ŒNodeæ˜¯åœ¨æœåŠ¡ç«¯ï¼‰ï¼Œå®ç°ä¸Šä¹Ÿæœ‰ä¸€å®šçš„å·®å¼‚ã€‚

ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹ï¼Œwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰æ¨¡å—åŒ–çš„ã€‚

3.1. æ¨¡å—å¯¹è±¡
å’ŒNodeçš„æ¨¡å—åŒ–å®ç°ç±»ä¼¼ï¼Œåœ¨webpackæ‰“åŒ…å‡ºçš„ä»£ç ä¸­ï¼Œæ¯ä¸ªæ¨¡å—ä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„æ¨¡å—å¯¹è±¡ã€‚åœ¨__webpack_require__()æ–¹æ³•ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

function __webpack_require__(moduleId) {
    // â€¦â€¦ other code
    
    var module = installedModules[moduleId] = {
        i: moduleId,
        l: false,
        exports: {},
        parents: null,
        children: []
    };
    
    // â€¦â€¦ other code
}
ç±»ä¼¼äºNodeï¼Œåœ¨webpackä¸­å„ä¸ªæ¨¡å—çš„ä¹Ÿæœ‰å¯¹åº”çš„æ¨¡å—å¯¹è±¡ï¼Œå…¶æ•°æ®ç»“æ„åŸºæœ¬éµå¾ªCommonJSè§„èŒƒï¼›å…¶ä¸­installedModulesåˆ™æ˜¯æ¨¡å—ç¼“å­˜å¯¹è±¡ï¼Œç±»ä¼¼äºNodeä¸­çš„require.cache/Module._cacheã€‚

2.2. æ¨¡å—çš„requireï¼š__webpack_require__
__webpack_require__æ˜¯webpackå‰ç«¯è¿è¡Œæ—¶æ¨¡å—åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç›¸å½“äºCommonJSè§„èŒƒä¸­çš„requireã€‚

æ ¹æ®ç¬¬ä¸€éƒ¨åˆ†çš„æµç¨‹å›¾ï¼šåœ¨Nodeä¸­ï¼Œå½“æˆ‘ä»¬requireä¸€ä¸ªæ¨¡å—æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­è¯¥æ¨¡å—æ˜¯å¦åœ¨ç¼“å­˜ä¹‹ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›è¯¥æ¨¡å—çš„exportså±æ€§ï¼›å¦åˆ™ä¼šåŠ è½½å¹¶æ‰§è¡Œè¯¥æ¨¡å—ã€‚webpackä¸­çš„å®ç°ä¹Ÿç±»ä¼¼ï¼š

function __webpack_require__(moduleId) {
    // 1.é¦–å…ˆä¼šæ£€æŸ¥æ¨¡å—ç¼“å­˜
    if(installedModules[moduleId]) {
        return installedModules[moduleId].exports;
    }
    
    // 2. ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºå¹¶ç¼“å­˜ä¸€ä¸ªæ–°çš„æ¨¡å—å¯¹è±¡ï¼Œç±»ä¼¼Nodeä¸­çš„new Moduleæ“ä½œ
    var module = installedModules[moduleId] = {
        i: moduleId,
        l: false,
        exports: {},
        children: []
    };

    // 3. æ‰§è¡Œæ¨¡å—ï¼Œç±»ä¼¼äºNodeä¸­çš„ï¼š
    // result = compiledWrapper.call(this.exports, this.exports, require, this, filename, dirname);
    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

    module.l = true;

    // 4. è¿”å›è¯¥moduleçš„è¾“å‡º
    return module.exports;
}
å¦‚æœä½ ä»”ç»†å¯¹æ¯”webpackä¸Nodeï¼Œä½ ä¼šå‘ç°åœ¨__webpack_require__ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼š

åœ¨webpackä¸­ä¸å­˜åœ¨åƒNodeä¸€æ ·è°ƒç”¨._compile()è¿™ç§æ–¹æ³•çš„è¿‡ç¨‹ã€‚å³ä¸ä¼šåƒNodeé‚£æ ·ï¼Œå¯¹ä¸€ä¸ªæœªè½½å…¥ç¼“å­˜çš„æ¨¡å—ï¼Œé€šè¿‡ã€Œè¯»å–æ¨¡å—è·¯å¾„ -> ç¼–è¯‘æ¨¡å—ä»£ç  -> æ‰§è¡Œæ¨¡å—ã€æ¥è½½å…¥æ¨¡å—ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºï¼ŒNodeä½œä¸ºæœåŠ¡ç«¯è¯­è¨€ï¼Œæ¨¡å—éƒ½æ˜¯æœ¬åœ°æ–‡ä»¶ï¼ŒåŠ è½½æ—¶å»¶ä½ï¼Œå¯åŒæ­¥é˜»å¡è¿›è¡Œæ¨¡å—æ–‡ä»¶å¯»å€ã€è¯»å–ã€ç¼–è¯‘å’Œæ‰§è¡Œï¼Œè¿™äº›è¿‡ç¨‹åœ¨æ¨¡å—requireçš„æ—¶å€™å†â€œæŒ‰éœ€â€æ‰§è¡Œå³å¯ï¼›è€Œwebpackè¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œæ˜¾ç„¶ä¸èƒ½åœ¨éœ€è¦æ—¶ï¼ˆå³æ‰§è¡Œ__webpack_require__æ—¶ï¼‰å†é€šè¿‡ç½‘ç»œåŠ è½½jsæ–‡ä»¶ï¼Œå¹¶åŒæ­¥åœ°ç­‰å¾…åŠ è½½å®Œæˆåå†è¿”å›__webpack_require__ã€‚è¿™ç§ç½‘ç»œæ—¶å»¶ï¼Œæ˜¾ç„¶ä¸èƒ½æ»¡è¶³â€œåŒæ­¥ä¾èµ–â€çš„è¦æ±‚ã€‚

é‚£ä¹ˆwebpackæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ

3.2. å¦‚ä½•è§£å†³å‰ç«¯çš„åŒæ­¥ä¾èµ–
æˆ‘ä»¬è¿˜æ˜¯å›æ¥çœ‹ä¸‹Nodeï¼š

Nodeï¼ˆv10ï¼‰ä¸­åŠ è½½ã€ç¼–è¯‘ä¸æ‰§è¡Œï¼ˆjsï¼‰æ¨¡å—çš„ä»£ç ä¸»è¦é›†ä¸­åœ¨Module._extensions['.js']å’ŒModule.prototype._compileä¸­ã€‚é¦–å…ˆä¼šé€šè¿‡fs.readFileSyncè¯»å–æ–‡ä»¶å†…å®¹ï¼Œç„¶åé€šè¿‡vm.runInThisContextæ¥ç¼–è¯‘å’Œæ‰§è¡ŒJavaScriptä»£ç ã€‚

The vm module provides APIs for compiling and running code within V8 Virtual Machine contexts.

ä½†æ˜¯ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œåœ¨å‰ç«¯runtimeä¸­è‚¯å®šä¸èƒ½é€šè¿‡ç½‘ç»œå»åŒæ­¥è·å–JavaScriptè„šæœ¬æ–‡ä»¶ï¼›é‚£ä¹ˆå°±éœ€è¦æˆ‘ä»¬æ¢ä¸€ä¸ªæ€è·¯ï¼šæœ‰æ²¡æœ‰ä»€ä¹ˆåœ°æ–¹èƒ½å¤Ÿé¢„å…ˆæ”¾ç½®æˆ‘ä»¬â€œä¹‹åâ€å¯èƒ½ä¼šéœ€è¦çš„æ¨¡å—ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨requireæ—¶ä¸éœ€è¦åŒæ­¥ç­‰å¾…è¿‡é•¿çš„æ—¶é—´ï¼ˆå½“ç„¶ï¼Œè¿™é‡Œçš„â€œä¹‹åâ€å¯èƒ½æ˜¯å‡ ç§’ã€å‡ åˆ†é’Ÿåï¼Œä¹Ÿå¯èƒ½æ˜¯è¿™æ¬¡äº‹ä»¶å¾ªç¯taskçš„ä¸‹å‡ è¡Œä»£ç ï¼‰ã€‚

å†…å­˜å°±æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æˆ‘ä»¬å¯ä»¥æŠŠåŒæ­¥ä¾èµ–çš„æ¨¡å—å…ˆâ€œæ³¨å†Œâ€åˆ°å†…å­˜ä¸­ï¼ˆæ¨¡å—æš‚å­˜ï¼‰ï¼Œç­‰åˆ°requireæ—¶ï¼Œå†æ‰§è¡Œè¯¥æ¨¡å—ã€ç¼“å­˜æ¨¡å—å¯¹è±¡ã€è¿”å›å¯¹åº”çš„exportsã€‚è€Œwebpackä¸­ï¼Œè¿™ä¸ªæ‰€è°“çš„å†…å­˜å°±æ˜¯moduleså¯¹è±¡ã€‚

æ³¨æ„è¿™é‡ŒæŒ‡çš„æ¨¡å—æš‚å­˜å’Œæ¨¡å—ç¼“å­˜æ¦‚å¿µå®Œå…¨ä¸åŒã€‚æš‚å­˜å¯ä»¥ç²—ç•¥ç±»æ¯”ä¸ºå°†ç¼–è¯‘å¥½çš„æ¨¡å—ä»£ç å…ˆæ”¾åˆ°å†…å­˜ä¸­ï¼Œå®é™…å¹¶æ²¡æœ‰å¼•å…¥è¯¥æ¨¡å—ã€‚åŸºäºè¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠâ€œæ¨¡å—æš‚å­˜â€ç†è§£ä¸ºâ€œæ¨¡å—æ³¨å†Œâ€ï¼Œå› æ­¤åæ–‡ä¸­â€œæ¨¡å—æš‚å­˜â€ä¸â€œæ¨¡å—æ³¨å†Œâ€å…·æœ‰ç›¸ç­‰çš„æ¦‚å¿µã€‚

æ‰€ä»¥ï¼Œè¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

å½“æˆ‘ä»¬å·²ç»è·å–äº†æ¨¡å—å†…å®¹åï¼ˆä½†æ¨¡å—è¿˜æœªæ‰§è¡Œï¼‰ï¼Œæˆ‘ä»¬å°±å°†å…¶æš‚å­˜åœ¨moduleså¯¹è±¡ä¸­ï¼Œé”®å°±æ˜¯webpackçš„moduleIdï¼›ç­‰åˆ°éœ€è¦ä½¿ç”¨__webpack_require__å¼•ç”¨æ¨¡å—æ—¶ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»moduleså¯¹è±¡ä¸­å–å‡ºæš‚å­˜çš„æ¨¡å—å¹¶æ‰§è¡Œã€‚

3.3. å¦‚ä½•â€æš‚å­˜â€œæ¨¡å—
æ€è·¯å·²ç»æ¸…æ™°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œwebpackæ˜¯å¦‚ä½•å°†æ¨¡å—â€œæš‚å­˜â€åœ¨moduleså¯¹è±¡ä¸Šçš„ã€‚åœ¨å®é™…ä¸Šï¼Œwebpackæ‰“åŒ…å‡ºæ¥çš„ä»£ç å¯ä»¥ç®€å•åˆ†ä¸ºä¸¤ç±»ï¼š

ä¸€ç±»æ˜¯webpackæ¨¡å—åŒ–çš„å‰ç«¯runtimeï¼Œä½ å¯ä»¥ç®€å•ç±»æ¯”ä¸ºRequireJSè¿™æ ·çš„å‰ç«¯æ¨¡å—åŒ–ç±»åº“æ‰€å®ç°çš„åŠŸèƒ½ã€‚å®ƒä¼šæ§åˆ¶æ¨¡å—çš„åŠ è½½ã€ç¼“å­˜ï¼Œæä¾›è¯¸å¦‚__webpack_require__è¿™æ ·çš„requireæ–¹æ³•ç­‰ã€‚
å¦ä¸€ç±»åˆ™æ˜¯æ¨¡å—æ³¨å†Œä¸è¿è¡Œçš„ä»£ç ï¼ŒåŒ…å«äº†æºç ä¸­çš„æ¨¡å—ä»£ç ã€‚ä¸ºäº†è¿›ä¸€æ­¥ç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™éƒ¨åˆ†çš„ä»£ç æ˜¯æ€æ ·çš„ã€‚
ä¸ºäº†ä¾¿äºå­¦ä¹ ä¸ä»£ç é˜…è¯»ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨webpackï¼ˆv4ï¼‰é…ç½®ä¸­åŠ å…¥optimization:{runtimeChunk: {name: 'runtime'}}ï¼Œè¿™æ ·ä¼šè®©webpackå°†runtimeä¸æ¨¡å—æ³¨å†Œä»£ç åˆ†å¼€æ‰“åŒ…ã€‚

// webpack module chunk
(window["webpackJsonp"] = window["webpackJsonp"] || []).push([["home-0"],{

/***/ "module-home-0":
/***/ (function(module, exports, __webpack_require__) {

const myalert = __webpack_require__("module-home-1");

myalert('test');

/***/ }),

/***/ "module-home-1":
/***/ (function(module, exports) {

module.exports = function (a) {
    alert('hi:' + a);
};

/***/ })

},[["module-home-0","home-1"]]]);
ä¸Šé¢è¿™æ˜¯ä¸€ä¸ªä¸åŒ…å«runtimeçš„chunkï¼Œæˆ‘ä»¬ä¸å¦¨å°†å…¶ç§°ä¸ºmodule chunkï¼ˆä¸‹é¢ä¼šæ²¿ç”¨è¿™ä¸ªå«æ³•ï¼‰ã€‚ç®€åŒ–ä¸€ä¸‹è¿™éƒ¨åˆ†ä»£ç ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š

// webpack module chunk
window["webpackJsonp"].push([
    ["home-0"], // chunkIds
    {
        "module-home-0": (function(module, exports, __webpack_require__){ /* some logic */ }),
        "module-home-1": (function(module, exports, __webpack_require__){ /* some logic */ })
    },
    [["module-home-0","home-1"]]
])
è¿™é‡Œï¼Œ.push()æ–¹æ³•å‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸‰ä¸ªå…ƒç´ ï¼š

ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ["home-0"]è¡¨ç¤ºè¯¥jsæ–‡ä»¶æ‰€åŒ…å«çš„æ‰€æœ‰chunkçš„idï¼ˆå¯ä»¥ç²—ç•¥ç†è§£ä¸ºï¼Œwebpackä¸­moduleç»„æˆchunkï¼Œchunkåˆç»„æˆfileï¼‰ï¼›
ç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®æ˜¯å„ä¸ªæ¨¡å—çš„idï¼Œå€¼åˆ™æ˜¯ä¸€ä¸ªè¢«functionåŒ…è£…åçš„æ¨¡å—ï¼›
ç¬¬ä¸‰ä¸ªå…ƒç´ ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶åˆæ˜¯ç”±å¤šä¸ªæ•°ç»„ç»„æˆã€‚å…·ä½“ä½œç”¨æˆ‘ä»¬å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œæœ€åå†è¯´ã€‚
æ¥çœ‹ä¸‹å‚æ•°æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´  â€”â€” åŒ…å«æ¨¡å—ä»£ç çš„å¯¹è±¡ï¼Œä½ ä¼šå‘ç°è¿™é‡Œæ–¹æ³•ç­¾åæ˜¯ä¸æ˜¯å¾ˆåƒNodeä¸­çš„é€šè¿‡Module.wrap()è¿›è¡Œçš„æ¨¡å—ä»£ç åŒ…è£…ï¼Ÿæ²¡é”™ï¼Œwebpackæºç ä¸­ä¹Ÿæœ‰ç±»ä¼¼ï¼Œä¼šåƒNodeé‚£æ ·ï¼Œå°†æ¯ä¸ªæ¨¡å—çš„ä»£ç ç”¨ä¸€ä¸ªfunctionåŒ…è£…èµ·æ¥ã€‚

è€Œå½“webpacké…ç½®äº†runtimeåˆ†ç¦»åï¼Œæ‰“åŒ…å‡ºçš„æ–‡ä»¶ä¸­ä¼šå‡ºç°ä¸€ä¸ªâ€œçº¯å‡€â€çš„ã€ä¸åŒ…å«ä»»ä½•æ¨¡å—ä»£ç çš„runtimeï¼Œå…¶ä¸»è¦æ˜¯ä¸€ä¸ªè‡ªæ‰§è¡Œæ–¹æ³•ï¼Œå…¶ä¸­æš´éœ²äº†ä¸€ä¸ªå…¨å±€å˜é‡webpackJsonpï¼š

// webpack runtime chunk
var jsonpArray = window["webpackJsonp"] = window["webpackJsonp"] || [];
var oldJsonpFunction = jsonpArray.push.bind(jsonpArray);
jsonpArray.push = webpackJsonpCallback;
webpackJsonpå˜é‡åå¯ä»¥é€šè¿‡output.jsonpFunctionè¿›è¡Œé…ç½®

å¯ä»¥çœ‹åˆ°ï¼Œwindow["webpackJsonp"]ä¸Šçš„.push()æ–¹æ³•å·²ç»è¢«ä¿®æ”¹ä¸ºäº†webpackJsonpCallback()æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹ï¼š

// webpack runtime chunk
function webpackJsonpCallback(data) {
    var chunkIds = data[0];
    var moreModules = data[1];
    var executeModules = data[2];

    var moduleId, chunkId, i = 0, resolves = [];
    // webpackä¼šåœ¨installChunksä¸­å­˜å‚¨chunkçš„è½½å…¥çŠ¶æ€ï¼Œæ®æ­¤åˆ¤æ–­chunkæ˜¯å¦åŠ è½½å®Œæ¯•
    for(;i < chunkIds.length; i++) {
        chunkId = chunkIds[i];
        if(installedChunks[chunkId]) {
            resolves.push(installedChunks[chunkId][0]);
        }
        installedChunks[chunkId] = 0;
    }
    
    // æ³¨æ„ï¼Œè¿™é‡Œä¼šè¿›è¡Œâ€œæ³¨å†Œâ€ï¼Œå°†æ¨¡å—æš‚å­˜å…¥å†…å­˜ä¸­
    // å°†module chunkä¸­ç¬¬äºŒä¸ªæ•°ç»„å…ƒç´ åŒ…å«çš„ module æ–¹æ³•æ³¨å†Œåˆ° modules å¯¹è±¡é‡Œ
    for(moduleId in moreModules) {
        if(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
            modules[moduleId] = moreModules[moduleId];
        }
    }

    if(parentJsonpFunction) parentJsonpFunction(data);

    while(resolves.length) {
        resolves.shift()();
    }

    deferredModules.push.apply(deferredModules, executeModules || []);

    return checkDeferredModules();
};
æ³¨æ„ä»¥ä¸Šæ–¹æ³•çš„è¿™å‡ è¡Œï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ã€Œå°†æ¨¡å—â€œæš‚å­˜â€åœ¨moduleså¯¹è±¡ä¸Šã€

// webpackJsonpCallback
for(moduleId in moreModules) {
    if(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
    modules[moduleId] = moreModules[moduleId];
    }
}
é…åˆ__webpack_require__()ä¸­ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå°±å®ç°äº†åœ¨éœ€è¦å¼•å…¥æ¨¡å—æ—¶ï¼ŒåŒæ­¥åœ°å°†æ¨¡å—ä»æš‚å­˜åŒºå–å‡ºæ¥æ‰§è¡Œï¼Œé¿å…ä½¿ç”¨ç½‘ç»œè¯·æ±‚å¯¼è‡´è¿‡é•¿çš„åŒæ­¥ç­‰å¾…æ—¶é—´ã€‚

// __webpack_require__
modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
3.4. æ¨¡å—çš„è‡ªåŠ¨æ‰§è¡Œ
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹äºwebpackçš„åŒæ­¥ä¾èµ–å®ç°å·²ç»ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œä½†è¿˜é—ç•™ä¸€ä¸ªå°é—®é¢˜ï¼šwebpackä¸­çš„æ‰€æœ‰jsæºæ–‡ä»¶éƒ½æ˜¯æ¨¡å—ï¼Œä½†å¦‚æœéƒ½æ˜¯ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œçš„æ¨¡å—ï¼Œé‚£æˆ‘ä»¬åªæ˜¯åœ¨å‰ç«¯å¼•å…¥äº†ä¸€å †â€œæ­»â€ä»£ç ï¼Œæ€ä¹ˆè®©ä»£ç â€œæ´»â€èµ·æ¥å‘¢ï¼Ÿ

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªscriptæ ‡ç­¾åŠ è½½è„šæœ¬æ–‡ä»¶ï¼Œè‡³å°‘å¸Œæœ›å…¶ä¸­ä¸€ä¸ªæ¨¡å—çš„ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯æ³¨å†Œåœ¨moduleså¯¹è±¡ä¸Šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å°±æ˜¯webpackä¸­æ‰€è°“çš„å…¥å£æ¨¡å—ã€‚

webpackæ˜¯å¦‚ä½•è®©è¿™äº›å…¥å£æ¨¡å—è‡ªåŠ¨æ‰§è¡Œçš„å‘¢ï¼Ÿä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—module chunkä¸­é‚£ä¸ªæŒ‰ä¸‹ä¸è¡¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè€Œæ•°ç»„é‡Œé¢æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªæ•°ç»„

[["module-home-0","home-1"], ["module-home-2","home-3","home-5"]]
å¯¹ç…§ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“è§£é‡Šä¸‹å‚æ•°çš„å«ä¹‰ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ ["module-home-0","home-1"]è¡¨ç¤ºï¼Œæˆ‘å¸Œæœ›è‡ªåŠ¨æ‰§è¡ŒmoduleIdä¸ºmodule-home-0çš„è¿™ä¸ªæ¨¡å—ï¼Œä½†æ˜¯è¯¥æ¨¡å—éœ€è¦chunkIdä¸ºhome-1çš„chunkå·²ç»åŠ è½½åæ‰èƒ½æ‰§è¡Œï¼›åŒç†ï¼Œ["module-home-2","home-3","home-5"]è¡¨ç¤ºè‡ªåŠ¨æ‰§è¡Œmodule-home-2æ¨¡å—ï¼Œä½†æ˜¯éœ€è¦æ£€æŸ¥chunkhome-3å’Œhome-5å·²ç»åŠ è½½ã€‚

æ‰§è¡ŒæŸäº›æ¨¡å—éœ€è¦ä¿è¯ä¸€äº›chunkå·²ç»åŠ è½½æ˜¯å› ä¸ºï¼Œè¯¥æ¨¡å—æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—å¯èƒ½å¹¶ä¸åœ¨å½“å‰chunkä¸­ï¼Œè€Œwebpackåœ¨ç¼–è¯‘æœŸä¼šé€šè¿‡ä¾èµ–åˆ†æè‡ªåŠ¨å°†ä¾èµ–æ¨¡å—çš„æ‰€å±chunkIdæ³¨å…¥åˆ°æ­¤å¤„ã€‚

è¿™ä¸ªæ¨¡å—â€œè‡ªåŠ¨â€æ‰§è¡Œçš„åŠŸèƒ½åœ¨runtime chunkçš„ä»£ç ä¸­ä¸»è¦æ˜¯ç”±checkDeferredModules()æ–¹æ³•å®ç°ï¼š

function checkDeferredModules() {
    var result;
    for(var i = 0; i < deferredModules.length; i++) {
        var deferredModule = deferredModules[i];
        var fulfilled = true;
        // ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ¨¡å—idï¼Œåé¢æ˜¯å…¶æ‰€éœ€çš„chunk
        for(var j = 1; j < deferredModule.length; j++) {
            var depId = deferredModule[j];
            // è¿™é‡Œä¼šé¦–å…ˆåˆ¤æ–­æ¨¡å—æ‰€éœ€chunkæ˜¯å¦å·²ç»åŠ è½½å®Œæ¯•
            if(installedChunks[depId] !== 0) fulfilled = false;
        }
        // åªæœ‰æ¨¡å—æ‰€éœ€çš„chunkéƒ½åŠ è½½å®Œæ¯•ï¼Œè¯¥æ¨¡å—æ‰ä¼šè¢«æ‰§è¡Œï¼ˆ__webpack_require__ï¼‰
        if(fulfilled) {
            deferredModules.splice(i--, 1);
            result = __webpack_require__(__webpack_require__.s = deferredModule[0]);
        }
    }
    return result;
}
4. å¼‚æ­¥ä¾èµ–
å¦‚æœä½ åªæ˜¯æƒ³å­¦ä¹ webpackå‰ç«¯runtimeä¸­åŒæ­¥ä¾èµ–çš„è®¾è®¡ä¸å®ç°ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œä¸»è¦å†…å®¹åŸºæœ¬å·²ç»ç»“æŸäº†ã€‚ä¸è¿‡æˆ‘ä»¬çŸ¥é“ï¼Œwebpackæ”¯æŒä½¿ç”¨åŠ¨æ€æ¨¡å—å¼•å…¥çš„è¯­æ³•ï¼ˆä»£ç æ‹†åˆ†ï¼‰ï¼Œä¾‹å¦‚ï¼šdynamic importå’Œæ—©æœŸçš„require.ensureï¼Œè¿™ç§æ–¹å¼ä¸ä½¿ç”¨CommonJSçš„requireå’ŒESMçš„importæœ€é‡è¦çš„åŒºåˆ«åœ¨äºï¼Œè¯¥ç±»æ–¹æ³•ä¼šå¼‚æ­¥ï¼ˆæˆ–è€…è¯´æŒ‰éœ€ï¼‰åŠ è½½ä¾èµ–ã€‚

4.1. ä»£ç è½¬æ¢
å°±åƒåœ¨æºç ä¸­ä½¿ç”¨requireä¼šåœ¨webpackæ‰“åŒ…æ—¶è¢«æ›¿æ¢ä¸º__webpack_require__ä¸€æ ·ï¼Œåœ¨æºç ä¸­ä½¿ç”¨çš„å¼‚æ­¥ä¾èµ–è¯­æ³•ä¹Ÿä¼šè¢«webpackä¿®æ”¹ã€‚ä»¥dynamic importä¸ºä¾‹ï¼Œä¸‹é¢çš„ä»£ç 

import('./test.js').then(mod => {
    console.log(mod);
});
åœ¨äº§å‡ºåä¼šè¢«è½¬æ¢ä¸º

__webpack_require__.e(/* import() */ "home-1")
    .then(__webpack_require__.bind(null, "module-home-3"))
    .then(mod => {
        console.log(mod);
    });
ä¸Šé¢ä»£ç æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œwebpackæ‰“åŒ…åä¼šå°†ä¸€äº›moduleåˆå¹¶ä¸ºä¸€ä¸ªchunkï¼Œå› æ­¤ä¸Šé¢çš„"home-1"å°±è¡¨ç¤ºï¼šåŒ…å«./test.jsæ¨¡å—çš„chunkçš„chunkIdä¸º"home-1"ã€‚

webpacké¦–å…ˆé€šè¿‡__webpack_require__.eåŠ è½½æŒ‡å®šchunkçš„scriptæ–‡ä»¶ï¼ˆmodule chunkï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªpromiseï¼Œå½“scriptåŠ è½½å¹¶æ‰§è¡Œå®Œæˆåresolveè¯¥promiseã€‚webpackæ‰“åŒ…æ—¶ä¼šä¿è¯å¼‚æ­¥ä¾èµ–çš„æ‰€æœ‰æ¨¡å—éƒ½å·²åŒ…å«åœ¨è¯¥module chunkæˆ–å½“å‰ä¸Šä¸‹æ–‡ä¸­ã€‚

æ—¢ç„¶module chunkå·²ç»æ‰§è¡Œï¼Œé‚£ä¹ˆè¡¨æ˜å¼‚æ­¥ä¾èµ–å·²ç»å°±ç»ªï¼Œäºæ˜¯åœ¨thenæ–¹æ³•ä¸­æ‰§è¡Œ__webpack_require__å¼•ç”¨test.jsæ¨¡å—ï¼ˆwebpackç¼–è¯‘åmoduleIdä¸ºmodule-home-3ï¼‰å¹¶è¿”å›ã€‚è¿™æ ·åœ¨ç¬¬äºŒä¸ªthenæ–¹æ³•ä¸­å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨è¯¥æ¨¡å—äº†ã€‚

4.2. __webpack_require__.e
å¼‚æ­¥ä¾èµ–çš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯__webpack_require__.eã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¯¥æ–¹æ³•ï¼š

__webpack_require__.e = function requireEnsure(chunkId) {
    var promises = [];
    var installedChunkData = installedChunks[chunkId];
    
    // åˆ¤æ–­è¯¥chunkæ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œ0è¡¨ç¤ºå·²åŠ è½½ã€‚installChunkä¸­çš„çŠ¶æ€ï¼š
    // undefinedï¼šchunkæœªè¿›è¡ŒåŠ è½½,
    // nullï¼šchunk preloaded/prefetched
    // Promiseï¼šchunkæ­£åœ¨åŠ è½½ä¸­
    // 0ï¼šchunkåŠ è½½å®Œæ¯•
    if(installedChunkData !== 0) {
        // chunkä¸ä¸ºnullå’Œundefinedï¼Œåˆ™ä¸ºPromiseï¼Œè¡¨ç¤ºåŠ è½½ä¸­ï¼Œç»§ç»­ç­‰å¾…
        if(installedChunkData) {
            promises.push(installedChunkData[2]);
        } else {
            // æ³¨æ„è¿™é‡ŒinstallChunkçš„æ•°æ®æ ¼å¼
            // ä»å·¦åˆ°å³ä¸‰ä¸ªå…ƒç´ åˆ†åˆ«ä¸ºresolveã€rejectã€promise
            var promise = new Promise(function(resolve, reject) {
                installedChunkData = installedChunks[chunkId] = [resolve, reject];
            });
            promises.push(installedChunkData[2] = promise);

            // ä¸‹é¢ä»£ç ä¸»è¦æ˜¯æ ¹æ®chunkIdåŠ è½½å¯¹åº”çš„scriptè„šæœ¬
            var head = document.getElementsByTagName('head')[0];
            var script = document.createElement('script');
            var onScriptComplete;

            script.charset = 'utf-8';
            script.timeout = 120;
            if (__webpack_require__.nc) {
                script.setAttribute("nonce", __webpack_require__.nc);
            }
            
            // jsonpScriptSrcæ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„chunkIdè¿”å›å¯¹åº”çš„æ–‡ä»¶è·¯å¾„
            script.src = jsonpScriptSrc(chunkId);

            onScriptComplete = function (event) {
                script.onerror = script.onload = null;
                clearTimeout(timeout);
                var chunk = installedChunks[chunkId];
                if(chunk !== 0) {
                    if(chunk) {
                        var errorType = event && (event.type === 'load' ? 'missing' : event.type);
                        var realSrc = event && event.target && event.target.src;
                        var error = new Error('Loading chunk ' + chunkId + ' failed.\n(' + errorType + ': ' + realSrc + ')');
                        error.type = errorType;
                        error.request = realSrc;
                        chunk[1](error);
                    }
                    installedChunks[chunkId] = undefined;
                }
            };
            var timeout = setTimeout(function(){
                onScriptComplete({ type: 'timeout', target: script });
            }, 120000);
            script.onerror = script.onload = onScriptComplete;
            head.appendChild(script);
        }
    }
    return Promise.all(promises);
};
è¯¥æ–¹æ³•é¦–å…ˆä¼šæ ¹æ®chunkIdåœ¨installChunksä¸­åˆ¤æ–­è¯¥chunkæ˜¯å¦æ­£åœ¨åŠ è½½æˆ–å·²ç»è¢«åŠ è½½ï¼›å¦‚æœæ²¡æœ‰åˆ™ä¼šåˆ›å»ºä¸€ä¸ªpromiseï¼Œå°†å…¶ä¿å­˜åœ¨installChunksä¸­ï¼Œå¹¶é€šè¿‡jsonpScriptSrc()æ–¹æ³•è·å–æ–‡ä»¶è·¯å¾„ï¼Œé€šè¿‡sciriptæ ‡ç­¾åŠ è½½ï¼Œæœ€åè¿”å›è¯¥promiseã€‚

jsonpScriptSrc()åˆ™å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåŒ…å«chunk mapçš„æ–¹æ³•ï¼Œä¾‹å¦‚è¿™ä¸ªä¾‹å­ä¸­ï¼š

function jsonpScriptSrc(chunkId) {
    return __webpack_require__.p + "" + ({}[chunkId]||chunkId) + "." + {"home-1":"0b49ae3b"}[chunkId] + ".js"
}
å…¶ä¸­åŒ…å«ä¸€ä¸ªmap â€”â€” {"home-1":"0b49ae3b"}ï¼Œä¼šæ ¹æ®home-1è¿™ä¸ªchunkIdè¿”å›home-1.0b49ae3b.jsè¿™ä¸ªæ–‡ä»¶åã€‚

4.3. æ›´æ–°chunkåŠ è½½çŠ¶æ€
æœ€åï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨onloadä¸­ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨promiseçš„resolveæ–¹æ³•ã€‚é‚£ä¹ˆæ˜¯ä½•æ—¶resolveçš„å‘¢ï¼Ÿ

ä½ è¿˜è®°å¾—åœ¨ä»‹ç»åŒæ­¥requireæ—¶ç”¨äºæ³¨å†Œmoduleçš„webpackJsonpCallback()æ–¹æ³•ä¹ˆï¼Ÿæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œè¯¥æ–¹æ³•å‚æ•°æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªchunkIdçš„æ•°ç»„ï¼Œä»£è¡¨äº†è¯¥è„šæœ¬æ‰€åŒ…å«çš„chunkã€‚

p.s. å½“ä¸€ä¸ªæ™®é€šçš„è„šæœ¬è¢«æµè§ˆå™¨ä¸‹è½½å®Œæ¯•åï¼Œä¼šå…ˆæ‰§è¡Œè¯¥è„šæœ¬ï¼Œç„¶åè§¦å‘onloadäº‹ä»¶ã€‚

å› æ­¤ï¼Œåœ¨webpackJsonpCallback()æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€æ®µä»£ç å°±æ˜¯æ ¹æ®chunkIdsçš„æ•°ç»„ï¼Œæ£€æŸ¥å¹¶æ›´æ–°chunkçš„åŠ è½½çŠ¶æ€ï¼š

// webpackJsonpCallback()
var moduleId, chunkId, i = 0, resolves = [];
for(;i < chunkIds.length; i++) {
    chunkId = chunkIds[i];
    if(installedChunks[chunkId]) {
        resolves.push(installedChunks[chunkId][0]);
    }
    installedChunks[chunkId] = 0;
}

// â€¦â€¦

while(resolves.length) {
    resolves.shift()();
}
ä¸Šé¢çš„ä»£ç å…ˆæ ¹æ®æ¨¡å—æ³¨å†Œæ—¶çš„chunkIdï¼Œå–å‡ºinstalledChunkså¯¹åº”çš„æ‰€æœ‰loadingä¸­çš„chunkï¼Œæœ€åå°†è¿™äº›chunkçš„promiseè¿›è¡Œresolveæ“ä½œã€‚

5. å†™åœ¨æœ€å
è‡³æ­¤ï¼Œå¯¹äºã€Œwebpackæ‰“åŒ…åæ˜¯å¦‚ä½•å®ç°å‰ç«¯æ¨¡å—åŒ–ã€è¿™ä¸ªé—®é¢˜å°±å·®ä¸å¤šç»“æŸäº†ã€‚æœ¬æ–‡é€šè¿‡Nodeä¸­çš„æ¨¡å—åŒ–ä¸ºå¼•å­ï¼Œä»‹ç»äº†webpackä¸­çš„åŒæ­¥ä¸å¼‚æ­¥æ¨¡å—åŠ è½½çš„è®¾è®¡ä¸å®ç°ã€‚